"""AI ê¸°ë°˜ ê±°ì‹œê²½ì œ ìš”ì•½ ìƒì„± ëª¨ë“ˆ"""
from anthropic import Anthropic
from typing import List, Optional
from datetime import datetime
import pytz

def generate_macro_summary(api_key: str, keywords: List[str]) -> Optional[str]:
    """ê±°ì‹œê²½ì œ ì£¼ìš” ì´ìŠˆ ìš”ì•½ ìƒì„± (Claude Opus 4.5)"""
    try:
        client = Anthropic(api_key=api_key)
        
        keyword_str = ", ".join(keywords)
        
        # í˜„ì¬ ë‚ ì§œ (í•œêµ­ ì‹œê°„)
        kst = pytz.timezone('Asia/Seoul')
        today = datetime.now(kst)
        current_date = today.strftime('%Yë…„ %mì›” %dì¼')
        
        message = client.messages.create(
            model="claude-opus-4-5-20251101",
            max_tokens=1500,
            messages=[
                {
                    "role": "user",
                    "content": f"""ë‹¹ì‹ ì€ ì›ŒëŸ° ë²„í•ì˜ íˆ¬ì ì² í•™ì„ ë”°ë¥´ëŠ” ê°œì¸ íˆ¬ììë¥¼ ìœ„í•œ ê±°ì‹œê²½ì œ ë¶„ì„ê°€ì…ë‹ˆë‹¤.

ì˜¤ëŠ˜ ë‚ ì§œ: {current_date}

ì´ íˆ¬ììì˜ ì „ëµ:
- S&P 500 ETF ì½”ì–´ 70-100% (ì¥ê¸° ë³´ìœ )
- ê°œë³„ì£¼ 20-30% (AI ì—”ì§€ë‹ˆì–´, GOOGL/OXY/QCOM ì†ŒëŸ‰ ë³´ìœ )
- ê¸‰ë½ ì‹œì—ë§Œ ê·œì¹™ ê¸°ë°˜ ì¶”ê°€ ë§¤ìˆ˜ (-5%, -10% íŠ¸ë¦¬ê±°)
- ë‹¨ê¸° ë‰´ìŠ¤ì— í”ë“¤ë¦¬ì§€ ì•Šê³  ì¥ê¸° ê´€ì  ìœ ì§€

ìµœê·¼ ì£¼ìš” ê±°ì‹œê²½ì œ ì´ìŠˆë¥¼ ë‹¤ìŒ êµ¬ì¡°ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”:

í‚¤ì›Œë“œ: {keyword_str}

[ì‘ì„± êµ¬ì¡°]

1. ê±°ì‹œê²½ì œ í˜„í™© (2-3ë¬¸ì¥)
   â€¢ ì£¼ìš” ê²½ì œì§€í‘œ (CPI, ê¸ˆë¦¬, GDP ë“±)
   â€¢ ì‹œì¥ ë¶„ìœ„ê¸° ìš”ì•½

2. S&P 500 ì¥ê¸° ê´€ì  (3-4ë¬¸ì¥ ì„œìˆ í˜•)
   - í–¥í›„ 3-5ë…„ êµ¬ì¡°ì  ì˜í–¥
   - ë²„í•ì´ë¼ë©´ ì–´ë–»ê²Œ ë³¼ì§€

3. ê¸‰ë½ ë§¤ìˆ˜ íŒë‹¨
   â€¢ í˜„ì¬ ì‹œì¥ ìƒíƒœ: (ê³ í‰ê°€/ì ì •/ì €í‰ê°€)
   â€¢ ì¶”ì²œ ì•¡ì…˜: (í˜„ê¸ˆ ìœ ì§€ / ë§¤ìˆ˜ ëŒ€ê¸° / ì¶”ê°€ ë§¤ìˆ˜)
   â€¢ ê·¼ê±°: (1-2ë¬¸ì¥)
   â€¢ **ì¤‘ìš”**: S&P 500 PER í‰ê°€ ì‹œ "ì—­ì‚¬ì  í‰ê· "ì´ ì•„ë‹Œ "ìµœê·¼ 5ë…„ í‰ê· "ê³¼ ë¹„êµí•˜ì„¸ìš”. í˜„ì¬ PERì´ ìµœê·¼ 5ë…„ í‰ê· ë³´ë‹¤ ë†’ìœ¼ë©´ ê³ í‰ê°€, ë‚®ìœ¼ë©´ ì €í‰ê°€ë¡œ íŒë‹¨.

4. AI/í…Œí¬ ëª¨íŠ¸ ì ê²€ (ê°œì¡°ì‹)
   â€¢ GOOGL: ëª¨íŠ¸ ìƒíƒœ
   â€¢ QCOM: ëª¨íŠ¸ ìƒíƒœ
   â€¢ OXY: ëª¨íŠ¸ ìƒíƒœ
   â€¢ ì„¹í„° ë¦¬ìŠ¤í¬: ì£¼ìš” ì´ìŠˆ

[ì‘ì„± ê·œì¹™]
- ê°œì¡°ì‹(â€¢)ê³¼ ì„œìˆ í˜• ì ì ˆíˆ í˜¼í•©
- ë§ˆí¬ë‹¤ìš´ ê¸ˆì§€ (#, **, -, |)
- ëª…í™•í•˜ê³  ì‹¤ìš©ì ì¸ í†¤
- PER íŒë‹¨ì€ ë°˜ë“œì‹œ "ìµœê·¼ 5ë…„ í‰ê· " ê¸°ì¤€
- í•œê¸€ë¡œ ì‘ì„±
- **ì¤‘ìš”**: ì˜¤ëŠ˜ ë‚ ì§œëŠ” {current_date}ì…ë‹ˆë‹¤. ì‘ë‹µì— ë‚ ì§œë¥¼ ëª…ì‹œí•  ë•Œ ì´ ë‚ ì§œë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•˜ì„¸ìš”.
"""
                }
            ]
        )
        
        if message.content and len(message.content) > 0:
            return message.content[0].text
        else:
            return None
            
    except Exception as e:
        print(f"AI ìš”ì•½ ìƒì„± ì‹¤íŒ¨: {e}")
        return "ğŸ“Œ AI ê±°ì‹œê²½ì œ ìš”ì•½ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì£¼ìš” ê²½ì œ ì´ìŠˆëŠ” ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”."