"""AI ê¸°ë°˜ ê±°ì‹œê²½ì œ ìš”ì•½ ìƒì„± ëª¨ë“ˆ"""
from anthropic import Anthropic
from typing import List, Optional
from datetime import datetime
import pytz

def generate_macro_summary(api_key: str, keywords: List[str]) -> Optional[str]:
    """ê±°ì‹œê²½ì œ ì£¼ìš” ì´ìŠˆ ìš”ì•½ ìƒì„± (Claude Opus 4.5)"""
    try:
        client = Anthropic(api_key=api_key)
        
        keyword_str = ", ".join(keywords)
        
        # í˜„ì¬ ë‚ ì§œ (í•œêµ­ ì‹œê°„)
        kst = pytz.timezone('Asia/Seoul')
        today = datetime.now(kst)
        current_date = today.strftime('%Yë…„ %mì›” %dì¼')
        
        message = client.messages.create(
            model="claude-opus-4-5-20251101",
            max_tokens=3500,
            tools=[
                {
                    "type": "web_search_20260209",
                    "name": "web_search"
                }
            ],
            messages=[
                {
                    "role": "user",
                    "content": f"""ë‹¹ì‹ ì€ ì›ŒëŸ° ë²„í•ì˜ íˆ¬ì ì² í•™ì„ ë”°ë¥´ëŠ” ê°œì¸ íˆ¬ììë¥¼ ìœ„í•œ ê±°ì‹œê²½ì œ ë¶„ì„ê°€ì…ë‹ˆë‹¤.

ì˜¤ëŠ˜ ë‚ ì§œ: {current_date}

ì´ íˆ¬ììì˜ ì „ëµ:
- S&P 500 ETF ì½”ì–´ 70-100% (ì¥ê¸° ë³´ìœ )
- ê°œë³„ì£¼ ë³´ìœ : GOOGL 2ì£¼, OXY 1ì£¼, QCOM 2ì£¼
- ê¸‰ë½ ì‹œì—ë§Œ ê·œì¹™ ê¸°ë°˜ ì¶”ê°€ ë§¤ìˆ˜ (-5%, -10% íŠ¸ë¦¬ê±°)
- ë‹¨ê¸° ë‰´ìŠ¤ì— í”ë“¤ë¦¬ì§€ ì•Šê³  ì¥ê¸° ê´€ì  ìœ ì§€

ìµœê·¼ ì£¼ìš” ì´ìŠˆë¥¼ ë‹¤ìŒ êµ¬ì¡°ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”:

í‚¤ì›Œë“œ: {keyword_str}

[ì‘ì„± êµ¬ì¡°]

1. ë¯¸êµ­ ì£¼ìš” ì§€ìˆ˜ (ë°˜ë“œì‹œ ì›¹ ê²€ìƒ‰ ì‚¬ìš© | ì§€ìˆ˜, ì¢…ê°€, ì „ì¼ë¹„, ë“±ë½ë¥  í‘œì‹œ)
   â€¢ S&P 500: $x,xxx.xx (ì „ì¼ë¹„ +xx.xx, +x.xx%)
   â€¢ Nasdaq: $xx,xxx.xx (ì „ì¼ë¹„ +xx.xx, +0.xx%)
   â€¢ Dow Jones: $xx,xxx.xx (ì „ì¼ë¹„ +xxx.xx, +x.xx%)
   â€¢ Russell 2000: $x,xxx.xx (ì „ì¼ë¹„ +x.xx, +x.xx%)

2. ê±°ì‹œê²½ì œ í˜„í™© (2-3ë¬¸ì¥)
   â€¢ ì£¼ìš” ê²½ì œì§€í‘œ (CPI, ê¸ˆë¦¬, GDP ë“±)
   â€¢ ì‹œì¥ ë¶„ìœ„ê¸° ìš”ì•½

3. íˆ¬ìì ì‹¬ë¦¬ ì§€í‘œ (ë°˜ë“œì‹œ ì›¹ ê²€ìƒ‰ìœ¼ë¡œ ìµœì‹  ìˆ˜ì¹˜ í™•ì¸)
   â€¢ VIX ì§€ìˆ˜: xx.xx (í‰ê°€: ë‚®ìŒ/ë³´í†µ/ë†’ìŒ)
   â€¢ CNN Fear & Greed Index: xx (í‰ê°€: ê·¹ë‹¨ì  ê³µí¬/ê³µí¬/ì¤‘ë¦½/íƒìš•/ê·¹ë‹¨ì  íƒìš•)
   â€¢ í•´ì„: (1-2ë¬¸ì¥, ë²„í• ê´€ì )

4. S&P 500 ì¥ê¸° ê´€ì  (3-4ë¬¸ì¥ ì„œìˆ í˜•)
   - í–¥í›„ 3-5ë…„ êµ¬ì¡°ì  ì˜í–¥
   - ë²„í•ì´ë¼ë©´ ì–´ë–»ê²Œ ë³¼ì§€

5. ê¸‰ë½ ë§¤ìˆ˜ íŒë‹¨
   â€¢ í˜„ì¬ ì‹œì¥ ìƒíƒœ: (ê³ í‰ê°€/ì ì •/ì €í‰ê°€)
   â€¢ ì¶”ì²œ ì•¡ì…˜: (í˜„ê¸ˆ ìœ ì§€ / ë§¤ìˆ˜ ëŒ€ê¸° / ì¶”ê°€ ë§¤ìˆ˜)
   â€¢ ê·¼ê±°: (1-2ë¬¸ì¥)
   â€¢ **ì¤‘ìš”**: S&P 500 PER í‰ê°€ ì‹œ "ì—­ì‚¬ì  í‰ê· "ì´ ì•„ë‹Œ "ìµœê·¼ 5ë…„ í‰ê· "ê³¼ ë¹„êµí•˜ì„¸ìš”. í˜„ì¬ PERì´ ìµœê·¼ 5ë…„ í‰ê· ë³´ë‹¤ ë†’ìœ¼ë©´ ê³ í‰ê°€, ë‚®ìœ¼ë©´ ì €í‰ê°€ë¡œ íŒë‹¨.

6. ë³´ìœ  ì¢…ëª©ë³„ ìµœì‹  ì´ìŠˆ (ë°˜ë“œì‹œ ì›¹ ê²€ìƒ‰ìœ¼ë¡œ ìµœê·¼ 1ì£¼ì¼ ë‰´ìŠ¤ í™•ì¸)
   GOOGL (Alphabet A)
   â€¢ ìµœê·¼ 1ì£¼ì¼ ì£¼ìš” ë‰´ìŠ¤ (2-3ë¬¸ì¥)
   â€¢ ì¶œì²˜ ëª…ì‹œ
   
   OXY (Occidental Petroleum)
   â€¢ ìµœê·¼ 1ì£¼ì¼ ì£¼ìš” ë‰´ìŠ¤ (2-3ë¬¸ì¥)
   â€¢ ë²„í¬ì…” ì§€ë¶„ í˜„í™© í¬í•¨
   â€¢ ì¶œì²˜ ëª…ì‹œ
   
   QCOM (Qualcomm)
   â€¢ ìµœê·¼ 1ì£¼ì¼ ì£¼ìš” ë‰´ìŠ¤ (2-3ë¬¸ì¥)
   â€¢ ì¶œì²˜ ëª…ì‹œ

7. ë‹¤ê°€ì˜¤ëŠ” ì£¼ìš” ì´ë²¤íŠ¸ (ì›¹ ê²€ìƒ‰ìœ¼ë¡œ í–¥í›„ 2ì£¼ ì´ë‚´ ì´ë²¤íŠ¸ í™•ì¸ | ë‚ ì§œ, ì´ë²¤íŠ¸, ì¤‘ìš”ë„ í¬í•¨)
   â€¢ ì˜ˆ: 2ì›” 25ì¼: FOMC ì˜ì‚¬ë¡ ê³µê°œ (ì¤‘ìš”ë„: ë†’ìŒ)
   â€¢ ì˜ˆ: 2ì›” 26ì¼: GOOGL íˆ¬ììì˜ ë‚  (ì¤‘ìš”ë„: ì¤‘ê°„)
   â€¢ ì˜ˆ: 3ì›” 5ì¼: ë¯¸êµ­ ê³ ìš© ë³´ê³ ì„œ ë°œí‘œ (ì¤‘ìš”ë„: ë†’ìŒ)
   â€¢ ì˜ˆ: 3ì›” 12ì¼: 2ì›” CPI ë°œí‘œ (ì¤‘ìš”ë„: ë†’ìŒ)
   â€¢ ë³´ìœ  ì¢…ëª© ì‹¤ì  ë°œí‘œ/íˆ¬ììì˜ ë‚  í¬í•¨

8. AI/í…Œí¬ ëª¨íŠ¸ ì ê²€ (ê°œì¡°ì‹)
   â€¢ GOOGL: ëª¨íŠ¸ ìƒíƒœ
   â€¢ QCOM: ëª¨íŠ¸ ìƒíƒœ
   â€¢ OXY: ëª¨íŠ¸ ìƒíƒœ
   â€¢ ì„¹í„° ë¦¬ìŠ¤í¬: ì£¼ìš” ì´ìŠˆ

[ì‘ì„± ê·œì¹™]
- ê°œì¡°ì‹(â€¢)ê³¼ ì„œìˆ í˜• ì ì ˆíˆ í˜¼í•©
- ë§ˆí¬ë‹¤ìš´ ê¸ˆì§€
- ëª…í™•í•˜ê³  ì‹¤ìš©ì ì¸ í†¤
- PER íŒë‹¨ì€ ë°˜ë“œì‹œ "ìµœê·¼ 5ë…„ í‰ê· " ê¸°ì¤€
- í•œê¸€ë¡œ ì‘ì„±
- **ì¤‘ìš”**: ì˜¤ëŠ˜ ë‚ ì§œëŠ” {current_date}ì…ë‹ˆë‹¤. ì‘ë‹µì— ë‚ ì§œë¥¼ ëª…ì‹œí•  ë•Œ ì´ ë‚ ì§œë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•˜ì„¸ìš”.
- **í•„ìˆ˜**: ì¢…ëª©ë³„ ë‰´ìŠ¤, ì£¼ìš” ì§€ìˆ˜, íˆ¬ìì ì‹¬ë¦¬ ì§€í‘œëŠ” ë°˜ë“œì‹œ ì›¹ ê²€ìƒ‰ì„ ì‚¬ìš©í•˜ì—¬ ìµœì‹  ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì„¸ìš”.
"""
                }
            ]
        )
        
        if message.content and len(message.content) > 0:
            # ì›¹ ê²€ìƒ‰ ê²°ê³¼ê°€ í¬í•¨ëœ ì‘ë‹µ ì²˜ë¦¬
            response_text = ""
            for block in message.content:
                if block.type == "text":
                    response_text += block.text
            return response_text if response_text else None
        else:
            return None
            
    except Exception as e:
        print(f"AI ìš”ì•½ ìƒì„± ì‹¤íŒ¨: {e}")
        return "ğŸ“Œ AI ê±°ì‹œê²½ì œ ìš”ì•½ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì£¼ìš” ê²½ì œ ì´ìŠˆëŠ” ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”."